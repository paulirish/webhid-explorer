<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>WebHID Explorer</title>
    <!-- 95% of this was generated by claude fyi. but i reviewed and and got rid of some dumb stuff. 
        there's a LOT of room for improvment but... w/e.
    -->
    <style>
      body {
        font-family: system-ui, -apple-system, sans-serif;
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
        line-height: 1.6;
      }

      .section {
        margin: 20px 0;
        padding: 20px;
        border: 1px solid #ddd;
        border-radius: 8px;
      }

      button {
        padding: 8px 16px;
        margin: 4px;
        border: none;
        border-radius: 4px;
        background: #0066cc;
        color: white;
        cursor: pointer;
      }

      button:hover {
        background: #0052a3;
      }

      .device-info {
        margin: 10px 0;
        padding: 10px;
        background: #f5f5f5;
        border-radius: 4px;
      }

      #inputReports {
        height: 200px;
        overflow-y: auto;
        padding: 10px;
        background: #f8f8f8;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-family: monospace;
      }

      .report-entry {
        border-bottom: 1px solid #eee;
      }

      .control-group {
        margin: 10px 0;
      }

      input[type='number'] {
        width: 60px;
        padding: 4px;
        margin: 0 4px;
      }

      dt {
        font-weight: bold;
        display: inline;
      }
      dd {
        display: inline;
        margin: 0 0 0 8px;
      }
    </style>
  </head>
  <body>
    <h1>WebHID Device Explorer</h1>
    <p>Lil' demo web tool for conveniently viewing device info, monitoring input reports, and sending output/feature reports.</p>

    <div class="section">
      <h2>Device Selection</h2>
      <button id="requestDevice">Connect to HID Device</button>
      <div id="deviceList"></div>
    </div>

    <div class="section">
      <h2>Input Reports</h2>
      <button id="startMonitoring">Start Monitoring</button>
      <button id="stopMonitoring">Stop Monitoring</button>
      <button id="clearReports">Clear Reports</button>
      <div id="inputReports"></div>
    </div>

    <div class="section">
      <h2>Output Reports</h2>
      <div class="control-group">
        <label>Report ID:</label>
        <input type="number" id="outputReportId" min="0" max="255" value="0" />
        <label>Data (comma-separated bytes):</label>
        <input type="text" id="outputData" placeholder="0,1,2,3" />
        <button id="sendOutput">Send Output Report</button>
      </div>
    </div>

    <div class="section">
      <h2>Feature Reports</h2>
      <div class="control-group">
        <label>Report ID:</label>
        <input type="number" id="featureReportId" min="0" max="255" value="0" />
        <label>Data (comma-separated bytes):</label>
        <input type="text" id="featureData" placeholder="0,1,2,3" />
        <button id="sendFeature">Send Feature Report</button>
        <button id="getFeature">Get Feature Report</button>
      </div>
    </div>

    Repo: <a href="https://github.com/paulirish/webhid-explorer">https://github.com/paulirish/webhid-explorer</a>

    <script>
      /* bling.js */
      window.$ = document.querySelector.bind(document);
      window.$$ = document.querySelectorAll.bind(document);
      Node.prototype.on = window.on = function (name, fn) {
        this.addEventListener(name, fn);
      };
      NodeList.prototype.__proto__ = Array.prototype;
      NodeList.prototype.on = function (name, fn) {
        this.forEach(elem => elem.on(name, fn));
      };

      let currentDevice = null;
      let isMonitoring = false;

      // Helper function to format DataView, highlighting non-zero values with indices
      // maybe a hex viewer thing would be nice in the future.
      function formatData(dataView) {
        const length = dataView.byteLength;
        const nonZeroIndices = [];

        // Find non-zero values
        for (let i = 0; i < length; i++) {
          const value = dataView.getUint8(i);
          if (value !== 0) {
            nonZeroIndices.push({index: i, value: value});
          }
        }

        if (nonZeroIndices.length === 0) {
          return 'All zeros';
        }

        if (nonZeroIndices.length == 1) return '-';

        // Format as "index: value" pairs for non-zero values
        return nonZeroIndices.map(({index, value}) => `[${index}]: 0x${value.toString(16).padStart(2, '0')} (${value})`).join(', ');
      }

      // Helper function to parse comma-separated values into Uint8Array
      function parseData(input) {
        const values = input.split(',').map(x => parseInt(x.trim()));
        return new Uint8Array(values);
      }

      // Add a report entry to the monitoring display
      function addReportEntry(text) {
        const reports = $('#inputReports');
        const entry = document.createElement('div');
        entry.className = 'report-entry';
        entry.textContent = text;
        reports.appendChild(entry);
        reports.scrollTop = reports.scrollHeight;
      }

      // Display device information
      function displayDeviceInfo(device) {
        const deviceList = $('#deviceList');
        deviceList.innerHTML = ''; // Clear existing content

        const info = document.createElement('div');
        info.className = 'device-info';

        const dl = document.createElement('dl');
        dl.style.margin = '0';

        // Helper function to add a term-description pair
        function addDetail(term, description) {
          const dt = document.createElement('dt');
          dt.textContent = term;
          const dd = document.createElement('dd');
          dd.textContent = description || 'N/A';
          const wrapper = document.createElement('div');
          wrapper.appendChild(dt);
          wrapper.appendChild(dd);
          dl.appendChild(wrapper);
        }

        // Add all device details
        addDetail('Product Name: ', device.productName);
        addDetail('Vendor ID: ', device.vendorId);
        addDetail('Product ID: ', device.productId);
        addDetail('Collection: ', device.collections[0]?.type);
        addDetail('Usage: ', device.collections[0]?.usage);
        addDetail('Usage Page: ', device.collections[0]?.usagePage);

        info.appendChild(dl);
        deviceList.appendChild(info);
      }

      // Request and open HID device
      $('#requestDevice').on('click', async () => {
        try {
          const [device] = await navigator.hid.requestDevice({
            filters: [], // Empty to show all HID devices
          });

          if (!device) return;

          await device.open();
          currentDevice = device;
          displayDeviceInfo(device);

          console.log('Connected to device:', device);
        } catch (error) {
          console.error('Error connecting to device:', error);
          alert('Error connecting to device: ' + error.message);
        }
      });

      // Input report monitoring
      $('#startMonitoring').on('click', () => {
        if (!currentDevice) {
          alert('Please connect to a device first');
          return;
        }

        isMonitoring = true;
        currentDevice.addEventListener('inputreport', event => {
          if (!isMonitoring) return;

          const {reportId, data} = event;
          const timestamp = new Date().toISOString().split('T')[1].split('.')[0];
          addReportEntry(`${timestamp} - Report ID: ${reportId}, Data: ${formatData(data)}`);
        });
      });

      $('#stopMonitoring').on('click', () => {
        isMonitoring = false;
      });

      $('#clearReports').on('click', () => {
        $('#inputReports').innerHTML = '';
      });

      // Send output report
      $('#sendOutput').on('click', async () => {
        if (!currentDevice) {
          alert('Please connect to a device first');
          return;
        }

        try {
          const reportId = parseInt($('#outputReportId').value);
          const data = parseData($('#outputData').value);

          await currentDevice.sendReport(reportId, data);
          console.log('Output report sent');
        } catch (error) {
          console.error('Error sending output report:', error);
          alert('Error sending output report: ' + error.message);
        }
      });

      // Send feature report
      $('#sendFeature').on('click', async () => {
        if (!currentDevice) {
          alert('Please connect to a device first');
          return;
        }

        try {
          const reportId = parseInt($('#featureReportId').value);
          const data = parseData($('#featureData').value);

          await currentDevice.sendFeatureReport(reportId, data);
          console.log('Feature report sent');
        } catch (error) {
          console.error('Error sending feature report:', error);
          alert('Error sending feature report: ' + error.message);
        }
      });

      // Get feature report
      $('#getFeature').on('click', async () => {
        if (!currentDevice) {
          alert('Please connect to a device first');
          return;
        }

        try {
          const reportId = parseInt($('#featureReportId').value);
          const report = await currentDevice.receiveFeatureReport(reportId);

          addReportEntry(`Feature Report ${reportId} received: ${formatData(report)}`);
        } catch (error) {
          console.error('Error getting feature report:', error);
          alert('Error getting feature report: ' + error.message);
        }
      });
    </script>
  </body>
</html>
